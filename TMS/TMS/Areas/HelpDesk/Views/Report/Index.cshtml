@{
    Layout = "~/Areas/HelpDesk/Views/Shared/_Layout.cshtml";
    //ViewBag.Title = "Ticket Management";
}
<style type="text/css">
    /*@@media print {
        body * {
          display: none;
        }

        body .printable {
          display: block;
        }
      }*/
</style>
<link rel="stylesheet" href="~/Content/css/graph.css" />

<div class="row" id="graph-condition-div">
    <div class="col-xs-8">
        <div class="box box-primary">
            <div class="box-body" id="draw-graph">
                <canvas id="pieChart" width="400" height="200"></canvas>
                <div id="doughnut-legend"></div>
            </div>
        </div>
    </div>
    <div class="col-xs-4">
        <div class="box box-primary">
            <div class="box-body">
                <br />
                <div class="form-horizontal">
                    <!--Dropdown type-->
                    <div class="form-group">
                        <label class="col-sm-5 control-label">Type:</label>
                        <div class="col-sm-7">
                            <select class="form-control" id="dropdownType">
                                <option value="0" selected="selected">All tickets</option>
                                <option value="1">All requests</option>
                                <option value="2">All problems</option>
                                <option value="3">All changes</option>
                                <option value="4">All pending requests</option>
                                <option value="5">All pending problems</option>
                                <option value="6">All pending changes</option>
                            </select>
                        </div>
                    </div>
                    <!--Dropdown By-->
                    <div class="form-group">
                        <label class="col-sm-5 control-label">By:</label>
                        <div class="col-sm-7">
                            <select class="form-control" id="dropdownBy">
                                <option value="0">Mode</option>
                                <option value="1">Category</option>
                                <option value="2">Impact</option>
                                <option value="3">Urgency</option>
                                <option value="4">Priority</option>
                                <option value="5">Department</option>
                                <option value="6" selected="selected">Status</option>
                            </select>
                        </div>
                    </div>
                    <!--Date From-->
                    <div class="form-group">
                        <label class="col-sm-5 control-label">Date From:</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control datetime" placeholder="DD/MM/YYYY" id="date-from-txt" value="@DateTime.Now.AddMonths(-1).ToShortDateString()">
                        </div>
                    </div>
                    <!--Date to-->
                    <div class="form-group">
                        <label class="col-sm-5 control-label">Date To:</label>
                        <div class="col-sm-7">
                            <input type="datetime" class="form-control datetime" placeholder="DD/MM/YYYY" id="date-to-txt" value="@DateTime.Now.ToShortDateString()">
                        </div>
                    </div>
                    <!--Button Generate Report-->
                    <div class="form-group">
                        <div class="col-sm-offset-4">
                            <button onclick="exportReport()">Export Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-xs-12" id="data-div">
    <div class="box box-primary">
        <!-- /.box-header -->
        <div class="box-body">
            <table class="table table-bordered table-hover" id="ticket-table-report">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Subject</th>
                        <th>Created Time</th>
                        <th>Schedule End Date</th>

                        <th>Actual End Date</th>
                        <th>Type</th>
                        <th>Mode</th>
                        <th>Catagory</th>

                        <th>Impact</th>
                        <th>Urgency</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Department</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- /.box-body -->
    </div>
    <!-- /.box -->
</div>
<div class="modal" id="loading-modal">
    <img src="~/Content/img/ajax-loader.gif" />
</div>

@section Scripts {
    @Scripts.Render("~/bundles/chart")
    <script src="~/Content/js/html2canvas.js"></script>
    <script src="~/Content/js/printThis.js"></script>
    <script>
        var defaultColors = [
            "#FF6384", "#36A2EB", "#FFCE56", "#f0f8ff", "#a4c639", "#8db600", "#ff9966", "#007fff", "#fae7b5",
            "#000000",
            "#318ce7", "#ace5ee", "#8a2be2", "#1dacd6", "#ffc1cc", "#536872", "#006b3c"
        ];
        var generatereport = $("#draw-graph");

        function ProcessGraph() {
            $.ajax({
                "url": "/HelpDesk/Report/DrawGraph",
                "method": "POST",
                "data": {
                    type: $("#dropdownType").val(),
                    by: $("#dropdownBy").val(),
                    date_from_select: $("#date-from-txt").val(),
                    date_to_select: $("#date-to-txt").val()
                },
                "success": function (data) {
                    drawChart(data.label, data.data)
                }
            });
        }

        function drawChart(chartLabels, chartData) {
            if (chartLabels == null) {
                $('#pieChart').replaceWith('<canvas id="pieChart"></canvas>');
                $.notify("No lables to draw chart", "success");
            } else if (chartData == null) {
                $('#pieChart').replaceWith('<canvas id="pieChart"></canvas>');
                $.notify("No data to draw chart", "success");
            }
            var colors = [];
            for (var i = 0; i < chartLabels.length; i++) {
                colors[i] = defaultColors[i];
            }

            $('#pieChart').replaceWith('<canvas id="pieChart"></canvas>');
            var pieChartCanvas = $("#pieChart").get(0).getContext("2d");
            var options = {
                legend: false,
                elements: {
                    arc: {
                        borderWidth: 0
                    }
                }
            }
            var data = {
                labels: chartLabels, // labels format: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
                datasets: [
                    {
                        data: chartData, // data format: [12, 19, 3, 5, 2, 3]
                        backgroundColor: colors
                        //hoverBackgroundColor: ["#FF6384", "#36A2EB", "#FFCE56"]
                    }
                ]
            }
            var pieChart = new Chart(pieChartCanvas,
            {
                type: "doughnut",
                data: data,
                options: options
            });
            $("#doughnut-legend").html(pieChart.generateLegend());

        }

        var ticketTableReport = $("#ticket-table-report")
            .dataTable({
                processing: true,
                serverSide: true,
                paging: false,
                sort: false,
                filter: false,
                ajax: ({
                    url: "/HelpDesk/Report/GetTickets",
                    type: "POST",
                    data: function (d) {
                        d.date_from_select = $("#date-from-txt").val(),
                            d.date_to_select = $("#date-to-txt").val(),
                            d.type = $("#dropdownType").val(),
                            d.by = $("#dropdownBy").val()
                    }
                }),
                drawCallback: function (settings) {
                    //var api = this.api();
                },
                "columnDefs": [
                    {
                        "render": function (data, type, row) {
                            return row[0];
                        },
                        // Code
                        "targets": 0,
                    },
                    {
                        "render": function (data, type, row) {
                            return row[1];
                        },
                        // Subject
                        "targets": 1
                    },
                    {
                        "render": function (data, type, row) {
                            return row[2]
                        },
                        // CreatedTime
                        "targets": 2
                    },
                    {
                        "render": function (data, type, row) {
                            return row[3]
                        },
                        // Schedule End Date
                        "targets": 3
                    },
                    {
                        "render": function (data, type, row) {
                            return row[4];
                        },
                        // Actual End Date
                        "targets": 4,
                    },
                    {
                        "render": function (data, type, row) {
                            return row[5];
                        },
                        // Type
                        "targets": 5
                    },
                    {
                        "render": function (data, type, row) {
                            return row[6];
                        },
                        // Mode
                        "targets": 6,
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[7];
                        },
                        // Category
                        "targets": 7,
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[8];
                        },
                        // impact
                        "targets": 8,
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[9];
                        },
                        // Urgency
                        "targets": 9,
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[10];
                        },
                        // Priority
                        "targets": 10,
                        "visible": false
                    },
                    {
                        "render": function (data, type, row) {
                            return row[11];
                        },
                        // Status
                        "targets": 11,
                        "visible": true
                    },
                    {
                        "render": function (data, type, row) {
                            return row[12];
                        },
                        // Department
                        "targets": 12,
                        "visible": false
                    }
                ]
            });



        var reloadDataTable = function () {
            var oTable = $("#ticket-table-report").dataTable();
            oTable.api().ajax.reload();
        };
        $("#dropdownType").on("change", function () {
            ProcessGraph();
            reloadDataTable();
        });

        var resetVisibleColumns = function () {
            var column = $("#ticket-table-report").dataTable().api().column("6");
            column.visible(false);
            column = $("#ticket-table-report").dataTable().api().column("7");
            column.visible(false);
            column = $("#ticket-table-report").dataTable().api().column("8");
            column.visible(false);
            column = $("#ticket-table-report").dataTable().api().column("9");
            column.visible(false);
            column = $("#ticket-table-report").dataTable().api().column("10");
            column.visible(false);
            column = $("#ticket-table-report").dataTable().api().column("11");
            column.visible(false);
            column = $("#ticket-table-report").dataTable().api().column("12");
            column.visible(false);
        }

        $("#dropdownBy").on("change", function () {
            ProcessGraph();
            var byValue = $(this).val();
            resetVisibleColumns();
            switch (byValue) {

                case "0": // Mode
                    var column = $("#ticket-table-report").dataTable().api().column("6");
                    column.visible(true);
                    break;
                case "1": // Category
                    var column = $("#ticket-table-report").dataTable().api().column("7");
                    column.visible(true);
                    break;

                case "2": //impact
                    var column = $("#ticket-table-report").dataTable().api().column("8");
                    column.visible(true);
                    break;

                case "3": //Urgency
                    var column = $("#ticket-table-report").dataTable().api().column("9");
                    column.visible(true);
                    break;

                case "4": // Priority
                    var column = $("#ticket-table-report").dataTable().api().column("10");
                    column.visible(true);
                    break;

                case "5": // Department
                    var column = $("#ticket-table-report").dataTable().api().column("12");
                    column.visible(true);
                    break;
                case "6": // Status
                    var column = $("#ticket-table-report").dataTable().api().column("11");
                    column.visible(true);
                    break;
            }


        });

        $("#date-from-txt").on("change",
                function () {
                    ProcessGraph();
                    ticketTableReport.fnDraw();
                    reloadDataTable();
                });

        $("#date-to-txt").on("change",
                function () {
                    ProcessGraph();
                    ticketTableReport.fnDraw();
                    reloadDataTable();
                });

        $(document).ready(function () {
            ProcessGraph();
        });

        var exportReport = function () {
            var graph_condition_div = document.getElementById("graph-condition-div");
            var data_div = document.getElementById("data-div");
            $("#loading-modal").modal('show');
            html2canvas(graph_condition_div, {
                onrendered: function (graph_condition_canvas) {
                    html2canvas(data_div, {
                        onrendered: function (data_canvas) {
                            var graph_condition_img = new Image;

                            graph_condition_img.id = 'graph-condition-img';    /// give an id so we can remove it in next step
                            graph_condition_img.src = graph_condition_canvas.toDataURL("image/png");
                            graph_condition_img.className = 'canvas-image'

                            var data_img = new Image;

                            data_img.id = 'data-img';    /// give an id so we can remove it in next step
                            data_img.src = data_canvas.toDataURL("image/png");
                            data_img.className = 'canvas-image'

                            var hide = $('<style>').html('body *:not(.canvas-image) { display: none !important; }').appendTo(document.head);
                            document.body.appendChild(graph_condition_img);
                            document.body.appendChild(data_img);

                            window.print();
                            $('#graph-condition-img').remove();
                            $('#data-img').remove();
                            $("#loading-modal").modal('hide');
                            hide.remove();
                        }
                    });
                }
            });
        }
    </script>
}